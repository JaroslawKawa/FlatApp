{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Lista zakupów</h2>

    <!-- Formularz dodawania produktu -->
    <form method="post" class="row g-3 mb-4">
    {% csrf_token %}

    <!-- Sekcja: dodawanie nowego produktu -->
    <div class="col-12 col-md-4">
        <label for="name" class="form-label">Nazwa produktu</label>
        <input type="text" name="name" id="name" class="form-control" placeholder="np. Jogurt" required>
    </div>

    <div class="col-12 col-md-4">
        <label for="category" class="form-label">Kategoria</label>
<select name="category" id="category" class="form-select">
    <option value="" {% if not selected_category %}selected{% endif %}>(brak kategorii)</option>
    {% for cat in categories %}
        <option value="{{ cat.id }}" {% if selected_category == cat.id %}selected{% endif %}>{{ cat.name }}</option>
    {% endfor %}
</select>
    </div>

    <!-- Ilość -->
    <div class="col-6 col-sm-4 col-md-2">
        <label for="quantity" class="form-label">Ilość</label>
        <input type="number" step="0.01" name="quantity" id="quantity" class="form-control" placeholder="Ilość">
    </div>

    <!-- Jednostka -->
    <div class="col-6 col-sm-4 col-md-2">
        <label for="unit" class="form-label">Jednostka</label>
        <select name="unit" id="unit" class="form-select">
            <option value="szt">szt</option>
            <option value="g">g</option>
            <option value="kg">kg</option>
            <option value="ml">ml</option>
            <option value="l">l</option>
            <option value="opak">opak</option>
        </select>
    </div>

    <div class="col-12 col-sm-4 col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Dodaj</button>
    </div>
</form>

<!-- Lista zakupów -->
{% for category, items_in_category in categorized_items.items %}
    <h4 class="mt-5">{{ category }}</h4>
    <ul class="list-group">
        {% for item in items_in_category %}
<li class="list-group-item d-flex flex-column gap-2 py-3 {% if item.in_cart %}bg-warning-subtle text-dark{% endif %}">
                <div class="fs-5 fw-semibold">{{ item.name }}</div>
                {% if item.quantity %}
                    <div class="fs-6 text-muted">{{ item.quantity }} {{ item.unit }}</div>
                {% endif %}
                <div class="fs-6 text-muted fst-italic">Dodane przez: {{ item.user.username }}</div>
<form action="{% url 'mark_bought' item.id %}" method="post" class="mb-2">
    {% csrf_token %}
    <button type="submit" class="btn btn-danger w-100">Kupione</button>
</form>

<form action="{% url 'toggle_in_cart' item.id %}" method="post">
    {% csrf_token %}
    <button type="submit" class="btn {% if item.in_cart %}btn-outline-warning{% else %}btn-outline-success{% endif %} w-100">
        {% if item.in_cart %}Usuń z koszyka{% else %}Do koszyka{% endif %}
    </button>
</form>
            </li>
        {% endfor %}
    </ul>
{% empty %}
    <p class="text-center fs-5">Brak rzeczy na liście.</p>
{% endfor %}
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Dodaj event listener do każdego formularza na stronie
  document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', () => {
      localStorage.setItem('scrollPos', window.scrollY);
    });
  });
});

window.addEventListener('load', () => {
  const scrollPos = localStorage.getItem('scrollPos');
  if (scrollPos) {
    setTimeout(() => {
      window.scrollTo(0, parseInt(scrollPos));
      localStorage.removeItem('scrollPos');
    }, 50);
  }
});
</script>


{% endblock %}
